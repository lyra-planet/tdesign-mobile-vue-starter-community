# 国际化 i18n

采用 `vue-i18n` 并进行懒加载与缓存优化，仅初始加载 `zh-cn`，其余语言按需加载。

## 懒加载（节选）

```ts
// src/plugins/i18n.ts
const localeFiles = import.meta.glob('../../locales/*.y(a)?ml', { eager: false })
const localeCache = new Map<string, any>()

async function loadLocaleMessages(locale: string) {
  if (localeCache.has(locale)) return localeCache.get(locale)
  const localeKey = `../../locales/${locale}.yaml`
  const loader = localeFiles[localeKey]
  if (!loader) return {}
  const module = await loader() as { default: any }
  const messages = module.default || {}
  localeCache.set(locale, messages)
  return messages
}
```

## 初始化与切换（节选）

```ts
export const i18n = createI18n({ legacy: false, locale: 'zh-cn', fallbackLocale: 'en-us', messages: {} })

export async function initializeI18n() {
  const initial = getStoredLocale()
  const messages = await loadLocaleMessages(initial)
  i18n.global.setLocaleMessage(initial, messages)
  ;(i18n.global.locale as any).value = initial
}

export async function setLanguage(locale: string) {
  if ((i18n.global.locale as any).value === locale) return
  if (localeCache.has(locale)) { (i18n.global.locale as any).value = locale; return }
  const messages = await loadLocaleMessages(locale)
  i18n.global.setLocaleMessage(locale, messages)
  ;(i18n.global.locale as any).value = locale
}
```

## 生产环境告警配置（减少噪音与运行时开销）

```ts
// src/plugins/i18n.ts（节选）
export const i18n = createI18n({
  legacy: false,
  locale: 'zh-cn',
  fallbackLocale: 'en-us',
  messages: {},
  // 仅开发启用缺失/回退告警；生产关闭以降低体积与噪音
  missingWarn: import.meta.env.DEV,
  fallbackWarn: import.meta.env.DEV,
  // 关闭 HTML 文本警告（避免不必要的 runtime 检查）
  warnHtmlMessage: false,
})
```

说明：`missingWarn`/`fallbackWarn` 在开发提示文案缺失与回退，有助于完善翻译；生产关闭可减少运行时开销。`warnHtmlMessage: false` 可避免在插值中使用 HTML 时的告警。

## 空闲时间预取常用次语言（切换零等待）

```ts
// src/plugins/i18n.ts（节选）
function scheduleIdle(task: () => void, timeout = 2000) {
  const ric = (window as any).requestIdleCallback as undefined | ((cb: IdleRequestCallback, opts?: { timeout?: number }) => number)
  if (typeof ric === 'function') ric(() => task(), { timeout })
  else setTimeout(task, 0)
}

function getLikelySwitchLocales(current: string): string[] {
  // 简单策略：中英互为高频；其余语言回退到中英
  if (current === 'zh-cn') return ['en-us']
  if (current === 'en-us') return ['zh-cn']
  return ['zh-cn', 'en-us'].filter(l => l !== current)
}

async function prefetchLikelyLocales(current: string) {
  const candidates = getLikelySwitchLocales(current)
  await Promise.all(candidates.map(async (locale) => {
    if (localeCache.has(locale)) return
    const messages = await loadLocaleMessages(locale)
    if (messages && Object.keys(messages).length > 0)
      i18n.global.setLocaleMessage(locale, messages)
  }))
}

export async function initializeI18n() {
  // ...加载并设置 initialLocale
  scheduleIdle(() => { void prefetchLikelyLocales(initialLocale) })
}

export async function setLanguage(locale: string) {
  // ...切换语言逻辑
  scheduleIdle(() => { void prefetchLikelyLocales(locale) })
}
```

提示：`requestIdleCallback` 不可用时自动降级为 `setTimeout(0)`，不会阻塞首屏与交互。

## 与 TDesign 组件库联动

在 `src/App.vue` 通过 `t-config-provider` 注入 TDesign 的本地化配置，来源由 `$storage.locale` 驱动：

```vue
<t-config-provider :global-config="currentLocale">
  <router-view />
</t-config-provider>
```

`currentLocale` 根据 `$storage.locale` 返回 `tdesign-mobile-vue/es/locale/zh_CN` 或 `en_US`。

## 启动流程

- `initGlobalConfig(app)` 注入 `$storage`（含默认 `locale`）
- `useI18n(app)` 安装 i18n 插件
- `initializeI18n()` 懒加载并设置初始语言包
- `App.vue` 在 `onBeforeMount` 同步 `locale.value = $storage.locale`

## 与配置/存储协作

- 个性化配置写入 `${storageNS}config`，读取见 `useStorage()`：

```ts
// src/config/index.ts（节选）
;(app.config.globalProperties as any).$storage = toReactive({
  locale: getGlobalConfig('locale'),
})
```

- 切换语言时同步更新 `$storage`，并持久化：

```ts
import { useGlobal } from '@/utils/global'
import { useAppStorage, storagePrefix } from '@/config'

const { $storage } = useGlobal()
const { setItem } = useAppStorage()

async function changeLocale(next: string) {
  await setLanguage(next)
  $storage.locale = next
  setItem(`${storagePrefix()}config`, { ...$storage })
}
```

## 文案组织建议

- 将公共文案放入 `locales/zh-cn.yaml`、`en-us.yaml`
- 页面专属文案以命名空间分组：`home.title`、`publish.submit`
- 对于动态插值，统一使用命名参数：`{ count } items`

## 最佳实践

- 按页面或模块组织文案，避免超大单文件
- 对常用语言先预热（首次进入时拉取），避免切换抖动
- 在导航中提供语言切换入口