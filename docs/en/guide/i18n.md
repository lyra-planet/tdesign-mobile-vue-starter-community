---
title: Internationalization
---

# Internationalization

We use `vue-i18n` with lazy loading and caching. Only `zh-cn` is initially loaded, and other locales are loaded on demand.

## Lazy loading (excerpt)

```ts
// src/plugins/i18n.ts
const localeFiles = import.meta.glob('../../locales/*.y(a)?ml', { eager: false })
const localeCache = new Map<string, any>()

async function loadLocaleMessages(locale: string) {
  if (localeCache.has(locale)) return localeCache.get(locale)
  const localeKey = `../../locales/${locale}.yaml`
  const loader = localeFiles[localeKey]
  if (!loader) return {}
  const module = await loader() as { default: any }
  const messages = module.default || {}
  localeCache.set(locale, messages)
  return messages
}
```

## Initialization and switching (excerpt)

```ts
export const i18n = createI18n({ legacy: false, locale: 'zh-cn', fallbackLocale: 'en-us', messages: {} })

export async function initializeI18n() {
  const initial = getStoredLocale()
  const messages = await loadLocaleMessages(initial)
  i18n.global.setLocaleMessage(initial, messages)
  ;(i18n.global.locale as any).value = initial
}

export async function setLanguage(locale: string) {
  if ((i18n.global.locale as any).value === locale) return
  if (localeCache.has(locale)) { (i18n.global.locale as any).value = locale; return }
  const messages = await loadLocaleMessages(locale)
  i18n.global.setLocaleMessage(locale, messages)
  ;(i18n.global.locale as any).value = locale
}
```

## Production warning settings (reduce noise and runtime overhead)

```ts
// src/plugins/i18n.ts (excerpt)
export const i18n = createI18n({
  legacy: false,
  locale: 'zh-cn',
  fallbackLocale: 'en-us',
  messages: {},
  // Enable missing/fallback warnings only in DEV; disable in PROD
  missingWarn: import.meta.env.DEV,
  fallbackWarn: import.meta.env.DEV,
  // Turn off HTML message warnings to avoid extra runtime checks
  warnHtmlMessage: false,
})
```

Rationale: `missingWarn`/`fallbackWarn` help detect missing translations during development, while disabling them in production reduces runtime cost. `warnHtmlMessage: false` avoids warnings when using HTML in messages.

## Idle prefetch for likely locales (zero-wait switching)

```ts
// src/plugins/i18n.ts (excerpt)
function scheduleIdle(task: () => void, timeout = 2000) {
  const ric = (window as any).requestIdleCallback as undefined | ((cb: IdleRequestCallback, opts?: { timeout?: number }) => number)
  if (typeof ric === 'function') ric(() => task(), { timeout })
  else setTimeout(task, 0)
}

function getLikelySwitchLocales(current: string): string[] {
  // Simple strategy: zh-cn <-> en-us are most common; others fall back to them
  if (current === 'zh-cn') return ['en-us']
  if (current === 'en-us') return ['zh-cn']
  return ['zh-cn', 'en-us'].filter(l => l !== current)
}

async function prefetchLikelyLocales(current: string) {
  const candidates = getLikelySwitchLocales(current)
  await Promise.all(candidates.map(async (locale) => {
    if (localeCache.has(locale)) return
    const messages = await loadLocaleMessages(locale)
    if (messages && Object.keys(messages).length > 0)
      i18n.global.setLocaleMessage(locale, messages)
  }))
}

export async function initializeI18n() {
  // ...load & set initialLocale
  scheduleIdle(() => { void prefetchLikelyLocales(initialLocale) })
}

export async function setLanguage(locale: string) {
  // ...switch logic
  scheduleIdle(() => { void prefetchLikelyLocales(locale) })
}
```

Note: when `requestIdleCallback` is unavailable, it gracefully falls back to `setTimeout(0)` so it won't block first paint or interactions.

## Link with TDesign components

In `src/App.vue`, inject TDesign locale via `t-config-provider`, driven by `$storage.locale`:

```vue
<t-config-provider :global-config="currentLocale">
  <router-view />
</t-config-provider>
```

`currentLocale` returns `tdesign-mobile-vue/es/locale/zh_CN` or `en_US` based on `$storage.locale`.

## Startup flow

- `initGlobalConfig(app)` injects `$storage` (with default `locale`)
- `useI18n(app)` installs the i18n plugin
- `initializeI18n()` lazy-loads and sets the initial locale messages
- `App.vue` syncs `locale.value = $storage.locale` in `onBeforeMount`

## Best practices

- Organize messages by page or module to avoid huge single files
- Pre-warm commonly used locales (fetch on first entrance) to avoid switching jank
- Provide a language switch entry in navigation
